language: php

addons:
  sonarcloud:
    organization: "ichhabrecht-github"
    branches:
      - master
      - sonar

cache:
  directories:
    - $HOME/.composer/cache/files
    - ./bin/.phpunit

jdk:
  - oraclejdk8

sudo: required

env:
  global:
    - SYMFONY_PHPUNIT_DIR=./bin/.phpunit
    - SYMFONY_DEPRECATIONS_HELPER=29

before_install:
  - '[[ "$TRAVIS_PHP_VERSION" == "nightly" ]] || phpenv config-rm xdebug.ini'
  - composer self-update

install:
  - composer install
  - ./bin/phpunit install

script:
  - ./bin/phpunit
  # this checks that the source code follows the Symfony Code Syntax rules
  - '[[ "$TRAVIS_PHP_VERSION" == "nightly" ]] || ./vendor/bin/php-cs-fixer fix --diff --dry-run -v'
  # this checks that the YAML config files contain no syntax errors
  - ./bin/console lint:yaml config
  # this checks that the Twig template files contain no syntax errors
  - ./bin/console lint:twig templates
  # this checks that the XLIFF translations contain no syntax errors
  - ./bin/console lint:xliff translations
  # this checks that the application doesn't use dependencies with known security vulnerabilities
  - ./bin/console security:check
  # this checks that Doctrine's mapping configurations are valid
  - ./bin/console doctrine:schema:validate --skip-sync -vvv --no-interaction

jobs:
  fast_finish: true
  allow_failures:
    - php: nightly
  include:
    - stage: test
      php: nightly
    - stage: test
      php: 7.2
    - stage: test
      php: 7.1.18

    - stage: âœ” with sonarqube scanner
      if: type = push AND branch IN (master, sonar) AND env(SONAR_TOKEN) IS present AND fork = false
      php: 7.2
      before_install: skip
      install:
      before_script:
      script:
        - git fetch --unshallow || true

        - >
          echo;
          echo "Running SonarQube Scanner";
          echo;
          echo;
          sonar-scanner;
